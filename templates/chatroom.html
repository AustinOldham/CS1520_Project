{% extends '_base.html' %}
{% block nav_index %}active{% endblock %}
{% block content %}
<script type="text/javascript">

	function sse()
	{  		
		var myEventSource = new EventSource("{{ url_for('load_chatroom', user=current_user, other=other_user) }}");

		console.log("sse() executing")

		myEventSource.onmessage = function(e) {
			var ul = document.getElementById("list");
			var li = document.createElement("li");
  			li.appendChild(document.createTextNode(str.concat(e.data)));
  			ul.appendChild(li);
			console.log("myEventSource triggered")
		};
		/*
		otherEventSource.onmessage = function(e) {
			var ul = document.getElementById("list");
			var li = document.createElement("li");
			var str = "JS "
  			li.appendChild(document.createTextNode(str.concat(e.data)));
  			ul.appendChild(li);
			console.log("otherEventSourc triggered")
		};*/		
	}

	//populate messages using JS
	function populateMessageList(){
		console.log("populateMessageList executing");

		var ul = document.getElementById("list");

		var messages = {{ messages | tojson }};
		for(var i=0;i<messages.length;i++){
			var li = document.createElement("li");
			console.log("messages[i] = " + messages[i]);
			var obj = JSON.parse(messages[i]);
			time = obj.time.split(" ")[1];
			li.appendChild(document.createTextNode(time.concat(' ', obj.from_user, ' ', obj.message)));
			if(obj.from_user == '{{current_user}}'){
				li.classList.add("pull-right");
			}else{
				li.classList.add("pull-left");
			}
			ul.appendChild(li);
			var br = document.createElement("br");
			ul.appendChild(br);
		}
	}
	sse();
	window.onload = populateMessageList;
</script>
<div class="row bg-light rounded mt-3">
	<div class="col-sm-1 mt-1">
		<img src="/static/images/{{other_user_avatar}}" class="img-fluid border border-dark rounded" style="width: auto; height: 50px;" alt="Profile picture">
	</div>
	<div class="col-sm-3 mt-3">
		<a href="{{ url_for('profile_page', username=other_user) }}" class="text-body">{{ other_user }}</a>
	</div>
</div>
<div class="container" style="word-wrap: break-word;">
	<style>
		.no-bullet{
			height:500px; width:100%;
			overflow:hidden; overflow-y:scroll;
		}

		.pull-left{
			float: left;
		}

		.pull-right{
			float: right;
		}
	</style>
	<ul class="no-bullet" style="list-style-type:none" id="list">
	</ul>
</div>
<!--
<div class="container" style="word-wrap: break-word;">
	{% for key in messages %}
	<div class="row bg-light rounded mt-3">
		<div class="col-sm-5 mt-3">
			<p>{{ key }}</p>
		</div>
	</div>
	{% endfor %}
</div>
-->
<form method="post" action="{{ url_for('load_chatroom', user=current_user, other=other_user) }}">
    <div class="form-group">
        <label for="messageInput">Type message here</label>
        <input type="text" name="message" class="form-control" id="messageInput">
    </div>
    <button type="submit" class="btn btn-primary">Send</button>
</form>
{% endblock %}